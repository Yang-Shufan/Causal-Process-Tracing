<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAUSAL DETECTIVE: THE BLACK BOX</title>
    <style>
        :root {
            /* é«˜ç«¯æš—è‰²ç³»é…è‰² */
            --bg-color: #0a0e17;
            --panel-bg: rgba(20, 25, 40, 0.8);
            --card-bg: rgba(30, 35, 50, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            
            /* å¼ºè°ƒè‰² */
            --primary: #d4af37; /* é¦™æ§Ÿé‡‘ - æ ¸å¿ƒäº¤äº’ */
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            
            /* å‡è®¾é¢œè‰² (æ›´ä¼˜é›…çš„é¥±å’Œåº¦) */
            --h1-color: #4db6ac; /* Tech Teal */
            --h2-color: #ff7043; /* Bureaucracy Coral */
            --h3-color: #9575cd; /* PR Purple */
            
            --font-main: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-mono: 'SF Mono', 'Consolas', monospace;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(77, 182, 172, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #app {
            width: 100%;
            max-width: 1280px;
            padding: 40px 20px;
            position: relative;
        }

        /* å±å¹•ç®¡ç† */
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        .screen.active {
            display: block;
            opacity: 1;
            animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* æ ‡é¢˜æ’ç‰ˆ */
        h1, h2, h3 { font-weight: 300; letter-spacing: 2px; margin-top: 0; }
        h1 { font-size: 3rem; color: var(--primary); text-transform: uppercase; margin-bottom: 10px; }
        .subtitle { color: var(--text-muted); font-family: var(--font-mono); font-size: 0.9rem; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 40px; }

        /* é«˜çº§å¡ç‰‡å®¹å™¨ */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        /* æŒ‰é’®è®¾è®¡ */
        button {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 15px 40px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            border-radius: 2px;
        }
        button:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
        }
        button.secondary { border-color: var(--text-muted); color: var(--text-muted); }
        button.secondary:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.05); box-shadow: none; }

        /* çŸ©é˜µç½‘æ ¼ */
        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 40px 0;
        }
        .matrix-item {
            background: rgba(255,255,255,0.03);
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: transform 0.3s;
        }
        .matrix-item:hover { transform: translateY(-2px); background: rgba(255,255,255,0.05); }
        .matrix-title { font-family: var(--font-mono); color: var(--primary); font-size: 0.8rem; margin-bottom: 10px; display: block; }
        .matrix-desc { font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; }

        /* æ¸¸æˆä¸»ç•Œé¢å¸ƒå±€ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            min-height: 80vh;
        }

        /* å·¦ä¾§ä¾§è¾¹æ  */
        .sidebar {
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 16px 0 0 16px;
            display: flex;
            flex-direction: column;
        }
        .chain-item {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .chain-item:last-child { border-bottom: none; }
        .chain-title { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .chain-viz { display: flex; gap: 4px; height: 6px; margin-top: 8px; }
        .chain-segment { flex: 1; background: rgba(255,255,255,0.1); border-radius: 1px; transition: all 0.5s ease; }
        
        /* é“¾æ¡çŠ¶æ€é¢œè‰² */
        .chain-segment.active-straw { background: var(--text-muted); box-shadow: 0 0 5px var(--text-muted); }
        .chain-segment.active-hoop { background: var(--h1-color); box-shadow: 0 0 8px var(--h1-color); }
        .chain-segment.active-smoking { background: var(--primary); box-shadow: 0 0 15px var(--primary); }

        /* åœ°å›¾ç½‘æ ¼ */
        .map-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .map-node {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .map-node::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.05) 100%);
            opacity: 0; transition: opacity 0.3s;
        }
        .map-node:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .map-node:hover::before { opacity: 1; }
        .map-node.visited { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        
        .node-icon { font-size: 2rem; margin-bottom: 15px; display: block; opacity: 0.8; }
        .node-title { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-main); font-weight: bold; }
        .node-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; display: block; }

        /* è°ƒæŸ¥ç•Œé¢ */
        .investigation-panel {
            padding: 40px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .evidence-card {
            background: rgba(0,0,0,0.3);
            border-left: 2px solid var(--primary);
            padding: 30px;
            margin: 30px 0;
            font-family: var(--font-mono);
            line-height: 1.8;
            color: var(--text-main);
        }
        
        /* é€‰é¡¹ç½‘æ ¼ */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: auto;
        }
        .option-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            text-align: left;
            border-radius: 8px;
            transition: 0.2s;
        }
        .option-btn:hover { background: rgba(255,255,255,0.05); border-color: var(--primary); }
        .option-btn strong { display: block; color: var(--text-main); margin-bottom: 5px; font-size: 1rem; }
        .option-btn small { color: var(--text-muted); font-size: 0.8rem; }

        /* æ¨¡æ€æ¡† */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-body {
            background: #1a1f2e;
            width: 500px;
            padding: 40px;
            border: 1px solid var(--primary);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.2);
            border-radius: 4px;
            text-align: center;
        }

        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .sidebar { border-radius: 16px 16px 0 0; border-right: none; border-bottom: 1px solid var(--border-color); }
        }
    </style>
</head>
<body>

<div id="app">

    <!-- SCREEN 1: INTRO -->
    <div id="screen-intro" class="screen active" style="text-align: center;">
        <div style="margin-top: 10vh;">
            <h1>Causal Detective</h1>
            <p class="subtitle">THE BLACK BOX OPERATION</p>
            
            <div class="glass-panel" style="max-width: 700px; margin: 0 auto; text-align: left;">
                <p style="font-size: 1.1rem; line-height: 1.8;">
                    æ¬¢è¿ï¼Œé«˜çº§ç ”ç©¶å‘˜ã€‚<br><br>
                    æ”¿ç­–ç ”ç©¶ä¸æ˜¯ç®€å•çš„â€œæ˜¯éé¢˜â€ï¼Œè€Œæ˜¯æ„å»º<b>è¯æ®é“¾</b>çš„è¿‡ç¨‹ã€‚<br>
                    åœ¨æœ¬æ¬¡è¡ŒåŠ¨ä¸­ï¼Œæˆ‘ä»¬ä¸è¿›è¡Œâ€œæ’é™¤æ³•â€ï¼Œè€Œæ˜¯ä¸“æ³¨äº<b>éªŒè¯</b>ã€‚<br><br>
                    ä½ çš„ä»»åŠ¡æ˜¯æœé›†è¯æ®ï¼Œå°½å¯èƒ½åœ°æ”¯æŒä¸‰ä¸ªç«äº‰æ€§å‡è®¾ã€‚æœ€ç»ˆï¼Œå“ªä¸€æ¡è¯æ®é“¾æœ€åšå›ºã€æœ€å®Œæ•´ï¼Œå“ªä¸€ä¸ªå°±æ˜¯çœŸç›¸ã€‚
                </p>
                <div style="margin-top: 40px; text-align: center;">
                    <button onclick="game.startTheory()">æ¥å—ä»»åŠ¡ (INITIALIZE)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: THEORY -->
    <div id="screen-theory" class="screen">
        <div class="glass-panel" style="max-width: 900px; margin: 50px auto;">
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 40px;">è¯æ®å¼ºåº¦åè®® (EVIDENCE PROTOCOL)</h2>
            
            <p style="text-align: center; color: var(--text-muted);">å¹¶ä¸æ˜¯æ‰€æœ‰è¯æ®éƒ½ç”Ÿè€Œå¹³ç­‰ã€‚æˆ‘ä»¬éœ€è¦è¯†åˆ«è¯æ®çš„å«é‡‘é‡ã€‚</p>

            <div class="matrix-grid">
                <div class="matrix-item">
                    <span class="matrix-title">1. é£ä¸­ä¹‹çƒ› (Straw-in-the-Wind)</span>
                    <div class="matrix-desc">
                        <strong>å¼ºåº¦ï¼šâ˜… (å¼±)</strong><br>
                        æ—¢ä¸å¿…è¦ä¹Ÿä¸å……åˆ†ã€‚å®ƒèƒ½å¾®å¼±åœ°æ”¯æŒå‡è®¾ï¼Œå¢åŠ ä¸€ç‚¹ç‚¹å¯ä¿¡åº¦ï¼Œä½†è¯´æ˜ä¸äº†å¤ªå¤šé—®é¢˜ã€‚
                    </div>
                </div>
                <div class="matrix-item">
                    <span class="matrix-title">2. ç¯å½¢æµ‹è¯• (Hoop Test)</span>
                    <div class="matrix-desc">
                        <strong>å¼ºåº¦ï¼šâ˜…â˜… (åŸºç¡€)</strong><br>
                        å¿…è¦ä½†ä¸å……åˆ†ã€‚å¦‚æœå‡è®¾æˆç«‹ï¼Œè¿™ä¸ªè¯æ®é€šå¸¸å¿…é¡»å­˜åœ¨ï¼ˆåŸºç¡€æ¡ä»¶ï¼‰ã€‚é€šè¿‡å®ƒï¼Œæˆ‘ä»¬ç¡®è®¤å‡è®¾å…·å¤‡äº†â€œå¯èƒ½æ€§â€ï¼Œä½†å°šæœªç¡®è¯ã€‚
                    </div>
                </div>
                <div class="matrix-item">
                    <span class="matrix-title">3. å¸çƒŸæª (Smoking Gun)</span>
                    <div class="matrix-desc">
                        <strong>å¼ºåº¦ï¼šâ˜…â˜…â˜… (å®é”¤)</strong><br>
                        å……åˆ†ä½†ä¸å¿…è¦ã€‚åªè¦æ‰¾åˆ°å®ƒï¼Œå‡è®¾åŸºæœ¬ç¡®ç«‹ã€‚å®ƒæ˜¯ç›´æ¥æ­ç¤ºå› æœæœºåˆ¶çš„å¼ºåŠ›è¯æ®ã€‚
                    </div>
                </div>
                <div class="matrix-item">
                    <span class="matrix-title">4. åŒé‡å†³å®š (Doubly Decisive)</span>
                    <div class="matrix-desc">
                        <strong>å¼ºåº¦ï¼šâ˜…â˜…â˜…â˜… (ç»æ€)</strong><br>
                        æ—¢å¿…è¦åˆå……åˆ†ã€‚å®Œç¾çš„è¯æ®ï¼Œæä¸ºç½•è§ã€‚
                    </div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button onclick="game.startTutorial()">è¿›å…¥æ¨¡æ‹Ÿè®­ç»ƒ</button>
            </div>
        </div>
    </div>

    <!-- SCREEN 3: TUTORIAL -->
    <div id="screen-tutorial" class="screen">
        <div class="glass-panel" style="max-width: 700px; margin: 50px auto;">
            <h3 style="margin-bottom: 20px;">æ¨¡æ‹Ÿè®­ç»ƒï¼šè›‹ç³•å¤±çªƒæ¡ˆ</h3>
            <p style="color: var(--text-muted);">ç›®æ ‡å‡è®¾ï¼š<b>â€œå°æåœ¨åŠå…¬å®¤å·åƒäº†è›‹ç³•â€</b></p>
            <hr style="border-color: var(--border-color); margin: 30px 0;">
            <div id="tutorial-content"></div>
        </div>
    </div>

    <!-- SCREEN 4: MAIN GAME -->
    <div id="screen-game" class="screen">
        <div class="glass-panel" style="max-width: 1200px; margin: 20px auto; padding: 0; overflow: hidden;">
            <div class="dashboard-grid">
                
                <!-- å·¦ä¾§è¾¹æ ï¼šè¯æ®é“¾çŠ¶æ€ -->
                <aside class="sidebar">
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 1.2rem; color: var(--text-main);">EVIDENCE CHAINS</h3>
                        <p style="font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono);">STATUS: UNCONFIRMED</p>
                    </div>

                    <div class="chain-item">
                        <div class="chain-title">
                            <span style="color: var(--h1-color);">H1 æŠ€æœ¯æ•…éšœ</span>
                            <span id="text-h1" style="opacity: 0.5;">æ— è¯æ®</span>
                        </div>
                        <div class="chain-viz" id="viz-h1">
                            <div class="chain-segment"></div><div class="chain-segment"></div><div class="chain-segment"></div>
                        </div>
                    </div>

                    <div class="chain-item">
                        <div class="chain-title">
                            <span style="color: var(--h2-color);">H2 å®˜åƒšæŠµåˆ¶</span>
                            <span id="text-h2" style="opacity: 0.5;">æ— è¯æ®</span>
                        </div>
                        <div class="chain-viz" id="viz-h2">
                            <div class="chain-segment"></div><div class="chain-segment"></div><div class="chain-segment"></div>
                        </div>
                    </div>

                    <div class="chain-item">
                        <div class="chain-title">
                            <span style="color: var(--h3-color);">H3 å®£ä¼ ä¸å½“</span>
                            <span id="text-h3" style="opacity: 0.5;">æ— è¯æ®</span>
                        </div>
                        <div class="chain-viz" id="viz-h3">
                            <div class="chain-segment"></div><div class="chain-segment"></div><div class="chain-segment"></div>
                        </div>
                    </div>

                    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-family: var(--font-mono);">
                            <span>AP (ACTION POINTS)</span>
                            <span id="ap-display" style="color: var(--primary);">5</span>
                        </div>
                        <button class="secondary" style="width: 100%;" onclick="game.endGameCheck()">æäº¤æœ€ç»ˆæŠ¥å‘Š</button>
                    </div>
                </aside>

                <!-- å³ä¾§ä¸»åŒºåŸŸ -->
                <div style="position: relative;">
                    
                    <!-- åœ°å›¾è§†å›¾ -->
                    <div id="view-map" class="map-container">
                        <!-- JS Generated -->
                    </div>

                    <!-- è°ƒæŸ¥è§†å›¾ (è¦†ç›–åœ¨åœ°å›¾ä¸Š) -->
                    <div id="view-investigation" class="investigation-panel" style="display: none; background: var(--panel-bg); position: absolute; top:0; left:0; width:100%; z-index: 10;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 id="inv-title" style="color: var(--primary);">LOC-01</h3>
                            <button class="secondary" style="padding: 10px 20px; font-size: 0.8rem;" onclick="game.backToMap()">è¿”å›åœ°å›¾</button>
                        </div>

                        <div class="evidence-card" id="evidence-text">
                            æ­£åœ¨è§£å¯†æ•°æ®...
                        </div>

                        <p style="color: var(--text-muted); margin-bottom: 20px;">
                            é’ˆå¯¹å‡è®¾ <strong id="target-h-name" style="color: #fff;">H?</strong>ï¼Œè¯¥è¯æ®å±äºå“ªç§å¼ºåº¦ï¼Ÿ
                        </p>

                        <div class="options-grid">
                            <div class="option-btn" role="button" onclick="game.submitAnalysis('straw')">
                                <strong>1. é£ä¸­ä¹‹çƒ› (Straw)</strong>
                                <small>å¾®å¼±æ”¯æŒã€‚æœ‰ç‚¹ç›¸å…³ï¼Œä½†æ— æ³•å®šè®ºã€‚</small>
                            </div>
                            <div class="option-btn" role="button" onclick="game.submitAnalysis('hoop')">
                                <strong>2. ç¯å½¢æµ‹è¯• (Hoop)</strong>
                                <small>åŸºç¡€æ”¯æŒã€‚é€šè¿‡äº†å¿…è¦æ€§æµ‹è¯•ï¼Œä½†è¿™åªæ˜¯å‰ææ¡ä»¶ã€‚</small>
                            </div>
                            <div class="option-btn" role="button" onclick="game.submitAnalysis('smoking')">
                                <strong>3. å¸çƒŸæª (Smoking Gun)</strong>
                                <small>å¼ºåŠ›æ”¯æŒã€‚å……åˆ†è¯æ˜äº†å› æœæœºåˆ¶çš„å­˜åœ¨ã€‚</small>
                            </div>
                            <div class="option-btn" role="button" onclick="game.submitAnalysis('doubly')">
                                <strong>4. åŒé‡å†³å®š (Doubly)</strong>
                                <small>ç»å¯¹ç¡®è¯ã€‚æ—¢å……åˆ†åˆå¿…è¦ï¼Œæ’é™¤å…¶ä»–ä¸€åˆ‡å¯èƒ½ã€‚</small>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 5: ENDING -->
    <div id="screen-end" class="screen">
        <div class="glass-panel" style="max-width: 800px; margin: 50px auto; text-align: center;">
            <h2 style="color: var(--primary);">ç»“æ¡ˆæŠ¥å‘Š (FINAL REPORT)</h2>
            <div id="end-content" style="text-align: left; margin: 40px 0; line-height: 1.8; color: var(--text-main);"></div>
            <button onclick="location.reload()">é‡å¯ç³»ç»Ÿ</button>
        </div>
    </div>

</div>

<!-- Modal -->
<div id="modal" class="modal-backdrop">
    <div class="modal-body">
        <h3 id="modal-title" style="color: var(--primary); margin-bottom: 20px;">INFO</h3>
        <p id="modal-text" style="color: var(--text-main); margin-bottom: 30px; line-height: 1.6;"></p>
        <button onclick="document.getElementById('modal').style.display='none'">ç¡®è®¤ (ACKNOWLEDGE)</button>
    </div>
</div>

<script>
// æ•°æ®é…ç½®
const tutorialData = [
    {
        text: "è¯æ® Aï¼šåœ¨å°æçš„åƒåœ¾æ¡¶é‡Œå‘ç°äº†è›‹ç³•åº—çš„åŒ…è£…çº¸ã€‚",
        question: "è¿™æ¡è¯æ®å¯¹å‡è®¾â€˜å°æå·åƒäº†è›‹ç³•â€™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ",
        correct: 'straw',
        msg: "æ­£ç¡®ã€‚è¿™æ˜¯<b>é£ä¸­ä¹‹çƒ›</b>ã€‚åŒ…è£…çº¸åªè¯´æ˜ä»–ä¹°è¿‡æˆ–åƒè¿‡è›‹ç³•ï¼Œä½†ä¸èƒ½è¯æ˜å·åƒäº†åŠå…¬å®¤é‚£å—ï¼ˆä¸å……åˆ†ï¼‰ï¼Œä¹Ÿæ²¡æ³•è¯æ˜ä»–å½“æ—¶åœ¨åœºã€‚ä»…ä»…æ˜¯å¾®å¼±çš„ç›¸å…³æ€§ã€‚"
    },
    {
        text: "è¯æ® Bï¼šç›‘æ§æ‹åˆ°å°æåœ¨èŒ¶æ°´é—´ï¼Œæ‰‹é‡Œæ‹¿ç€ä¸€å—å’Œä¸¢å¤±è›‹ç³•ä¸€æ¨¡ä¸€æ ·çš„è“è‰²è›‹ç³•åœ¨åƒã€‚",
        question: "è¿™æ¡è¯æ®å¯¹å‡è®¾â€˜å°æå·åƒäº†è›‹ç³•â€™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ",
        correct: 'smoking',
        msg: "æ­£ç¡®ã€‚è¿™æ˜¯<b>å¸çƒŸæª</b>ã€‚ç›‘æ§ç›´æ¥æ•æ‰åˆ°äº†è¡Œä¸ºï¼ˆåƒè›‹ç³•ï¼‰å’Œç‰¹å¾ï¼ˆè“è‰²ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå……åˆ†çš„è¯æ®ï¼Œè¶³ä»¥ç¡®ç«‹å‡è®¾ã€‚"
    }
];

const mainLocations = [
    {
        id: "loc_tech",
        title: "æŠ€æœ¯ç»´æŠ¤æ—¥å¿—",
        icon: "ğŸ’¾",
        subtitle: "IT éƒ¨é—¨æ•°æ®åº“",
        evidence: {
            text: "æ—¥å¿—æ˜¾ç¤ºç³»ç»Ÿåœ¨è¿è¡ŒæœŸé—´å¶æœ‰é«˜å»¶è¿Ÿè­¦æŠ¥ï¼ˆPingå€¼ > 500msï¼‰ï¼Œä¸”éƒ¨åˆ†æ—§å‹å·æ‰‹æœºçš„UIé€‚é…å­˜åœ¨é”™ä½é—®é¢˜ã€‚",
            targetH: "H1 æŠ€æœ¯æ•…éšœ",
            targetHName: "H1 æŠ€æœ¯æ•…éšœ",
            targetHKey: "h1",
            type: "straw", 
            // è§£é‡Šï¼šè¿™é‡ŒæŠŠâ€œæ— æŠ¥é”™â€æ”¹æˆäº†â€œæœ‰å°é—®é¢˜â€ã€‚
            // è¿™éªŒè¯äº†H1ï¼ˆç¡®å®æœ‰æŠ€æœ¯é—®é¢˜ï¼‰ï¼Œä½†è¿™äº›å°é—®é¢˜ä¸è¶³ä»¥å¯¼è‡´â€œæ²¡äººç”¨â€è¿™ä¹ˆå¤§çš„åæœã€‚
            // æ‰€ä»¥å®ƒæ˜¯éªŒè¯äº†å‡è®¾ï¼Œä½†å¼ºåº¦å¾ˆå¼±ï¼ˆStrawï¼‰ã€‚
            msg: "åˆ†æç²¾å‡†ã€‚è¿™æ˜¯<b>é£ä¸­ä¹‹çƒ› (Straw)</b>ã€‚<br>ä½ å‘ç°äº†ä¸€äº›æŠ€æœ¯ç‘•ç–µï¼Œè¿™ç¡®å®æ”¯æŒäº†H1ï¼ˆæŠ€æœ¯æœ‰é—®é¢˜ï¼‰ã€‚ä½†æ˜¯ï¼Œé«˜å»¶è¿Ÿå’ŒUIé”™ä½é€šå¸¸åªä¼šé™ä½ä½“éªŒï¼Œä¸ä¼šå¯¼è‡´ç”¨æˆ·æ•°ä¸ºé›¶ã€‚è¿™ä¸ªè¯æ®æ”¯æŒäº†å‡è®¾ï¼Œä½†åŠ›åº¦å¾®å¼±ã€‚"
        }
    },
    {
        id: "loc_pr",
        title: "å®£ä¼ ç‰©æ–™å­˜æ¡£",
        icon: "ğŸ“¢",
        subtitle: "åª’ä½“ä¸­å¿ƒ",
        evidence: {
            text: "ä½ æ‰¾åˆ°äº†å½“æ—¶çš„å®£ä¼ é¢„ç®—è¡¨ã€‚æ•°æ®æ˜¾ç¤ºï¼Œè¯¥é¡¹ç›®çš„å®£ä¼ é¢„ç®—ä»…ä¸ºåŒç±»é¡¹ç›®çš„ 50%ï¼Œä¸”ä¸»è¦æŠ•æ”¾æ¸ é“æ˜¯è€å¹´æŠ¥åˆŠï¼Œè€Œéå¹´è½»äººèšé›†çš„ç½‘ç»œå¹³å°ã€‚",
            targetH: "H3 å®£ä¼ ä¸å½“",
            targetHName: "H3 å®£ä¼ ä¸å½“",
            targetHKey: "h3",
            type: "hoop", 
            // è§£é‡Šï¼šè¿™æ˜¯éªŒè¯H3çš„å¿…è¦æ¡ä»¶ã€‚
            // å¦‚æœH3æˆç«‹ï¼ˆå®£ä¼ çƒ‚ï¼‰ï¼Œé‚£ä¹ˆå¿…é¡»æœ‰â€œé¢„ç®—å°‘/æ¸ é“åâ€çš„äº‹å®ã€‚
            // ç°åœ¨æ‰¾åˆ°äº†è¿™ä¸ªäº‹å®ï¼Œè¯´æ˜H3å…·å¤‡äº†æˆç«‹çš„åŸºç¡€ï¼ˆPassed Hoopï¼‰ã€‚
            // ä½†å®ƒä¸å……åˆ†ï¼Œå› ä¸ºå“ªæ€•è€å¹´äººä¹Ÿåº”è¯¥ç”¨ï¼Œç»“æœä¹Ÿæ²¡äººç”¨ã€‚
            msg: "åˆ†æç²¾å‡†ã€‚è¿™æ˜¯<b>ç¯å½¢æµ‹è¯• (Hoop Test)</b>ã€‚<br>ä½ è¯å®äº†å®£ä¼ èµ„æºä¸è¶³è¿™ä¸€äº‹å®ã€‚å¯¹äºâ€˜å®£ä¼ å¤±è´¥å¯¼è‡´æ— äººä½¿ç”¨â€™è¿™ä¸ªå‡è®¾æ¥è¯´ï¼Œâ€˜æŠ•å…¥ä¸è¶³â€™æ˜¯å¿…è¦çš„å…ˆå†³æ¡ä»¶ã€‚è¯æ®é€šè¿‡äº†ç¯å½¢æµ‹è¯•ï¼ŒH3 çš„åœ°åŸºå·²ç»æ‰“å¥½ï¼Œä½†è¿˜éœ€è¦æ›´ç›´æ¥çš„è¯æ®è¯æ˜å¸‚æ°‘çœŸçš„å› æ­¤ä¸çŸ¥é“APPã€‚"
        }
    },
    {
        id: "loc_counter",
        title: "åŠäº‹å¤§å…æš—è®¿",
        icon: "ğŸ‘ï¸",
        subtitle: "ä¸€çº¿çª—å£",
        evidence: {
            text: "ä½ å‡æ‰®å¸‚æ°‘å»åŠäº‹ã€‚çª—å£äººå‘˜å°å¼ æ˜ç¡®å‘Šè¯‰ä½ ï¼šâ€œåˆ«ç”¨é‚£ä¸ªAPPï¼Œæ•°æ®ä¸é€šçš„ã€‚â€éšåä½ å½•åˆ°äº†ä»–åœ¨ä¼‘æ¯å®¤çš„è°ˆè¯ï¼šâ€œå¹¸å¥½æŠŠä»–ä»¬åŠé€€äº†ï¼Œä¸ç„¶çº¿ä¸ŠåŠç»“ç‡ä¸€ä¸Šæ¥ï¼Œæˆ‘ä»¬çš„å²—ä½æ´¥è´´å°±æ²¡äº†ã€‚â€",
            targetH: "H2 å®˜åƒšæŠµåˆ¶",
            targetHName: "H2 å®˜åƒšæŠµåˆ¶",
            targetHKey: "h2",
            type: "smoking", 
            // è§£é‡Šï¼šéªŒè¯H2çš„å……åˆ†æ¡ä»¶ã€‚
            // æ—¢æœ‰é˜»æŒ è¡Œä¸ºï¼Œåˆæœ‰åˆ©ç›ŠåŠ¨æœºã€‚å®é”¤ã€‚
            msg: "åˆ†æç²¾å‡†ã€‚è¿™æ˜¯<b>å¸çƒŸæª (Smoking Gun)</b>ã€‚<br>ä½ ä¸ä»…è§‚å¯Ÿåˆ°äº†é˜»æŒ è¡Œä¸ºï¼ˆæ’’è°ï¼‰ï¼Œè¿˜æˆªè·äº†èƒŒåçš„åŠ¨æœºï¼ˆæ´¥è´´ï¼‰ã€‚è¿™ç›´æ¥æ­ç¤ºäº†å› æœæœºåˆ¶ï¼Œå……åˆ†è¯å®äº† H2 çš„æˆç«‹ã€‚"
        }
    },
    {
        id: "loc_user",
        title: "ç”¨æˆ·æŠ•è¯‰ä¿¡",
        icon: "âœ‰ï¸",
        subtitle: "ä¿¡è®¿åŠ",
        evidence: {
            text: "ä¸€å°å¸‚æ°‘æ¥ä¿¡å†™é“ï¼šâ€˜æˆ‘ä¸‹è½½äº†APPï¼Œä½†æ˜¯æ‰¾ä¸åˆ°æ³¨å†ŒæŒ‰é’®ï¼Œå­—ä½“å¤ªæ·¡äº†çœ‹ä¸æ¸…ã€‚â€™",
            targetH: "H1 æŠ€æœ¯æ•…éšœ",
            targetHName: "H1 æŠ€æœ¯æ•…éšœ",
            targetHKey: "h1",
            type: "straw", 
            // éªŒè¯H1ï¼Œä½†åªæ˜¯ä¸ªä¾‹ï¼ˆStrawï¼‰ã€‚
            msg: "åˆ†æç²¾å‡†ã€‚è¿™æ˜¯<b>é£ä¸­ä¹‹çƒ› (Straw)</b>ã€‚<br>è¿™ç¡®å®æ˜¯æŠ€æœ¯è®¾è®¡é—®é¢˜ï¼Œæ”¯æŒäº† H1ã€‚ä½†ä¸ªåˆ«ç”¨æˆ·æ‰¾ä¸åˆ°æŒ‰é’®ï¼Œæ— æ³•è§£é‡Šå…¨åŸæ— äººä½¿ç”¨çš„ç³»ç»Ÿæ€§å¤±è´¥ã€‚è¯æ®æœ‰æ•ˆï¼Œä½†å¼ºåº¦æœ‰é™ã€‚"
        }
    },
    {
        id: "loc_policy",
        title: "å†…éƒ¨è€ƒæ ¸æ–‡ä»¶",
        icon: "ğŸ“‘",
        subtitle: "æ¡£æ¡ˆå®¤",
        evidence: {
            text: "ä¸€ä»½ç›–æœ‰â€˜ç»å¯†â€™ç« çš„æ–‡ä»¶æ˜¾ç¤ºï¼šè¯¥å¹´åº¦çš„ç»©æ•ˆè€ƒæ ¸æŒ‡æ ‡ä¸­ï¼Œâ€˜çº¿ä¸‹çª—å£æ»¡æ„åº¦â€™æƒé‡ä¸º 80%ï¼Œè€Œâ€˜çº¿ä¸ŠåŠç†ç‡â€™ä¸è®¡å…¥è€ƒæ ¸ã€‚",
            targetH: "H2 å®˜åƒšæŠµåˆ¶",
            targetHName: "H2 å®˜åƒšæŠµåˆ¶",
            targetHKey: "h2",
            type: "hoop", 
            // éªŒè¯H2çš„å¿…è¦æ¡ä»¶ï¼ˆåˆ¶åº¦ç¯å¢ƒï¼‰ã€‚
            // å¦‚æœæ²¡æœ‰è¿™ä¸ªè€ƒæ ¸æœºåˆ¶ï¼ŒæŠµåˆ¶å¯èƒ½ä¸ä¼šå‘ç”Ÿã€‚
            msg: "åˆ†æç²¾å‡†ã€‚è¿™æ˜¯<b>ç¯å½¢æµ‹è¯• (Hoop Test)</b>ã€‚<br>è¿™éªŒè¯äº†å®˜åƒšæŠµåˆ¶çš„åˆ¶åº¦åŸºç¡€ï¼ˆå¿…è¦æ¡ä»¶ï¼‰ã€‚å¦‚æœè€ƒæ ¸æŒ‡æ ‡é¼“åŠ±çº¿ä¸Šï¼Œä»–ä»¬å°±ä¸ä¼šæŠµåˆ¶ã€‚ç°åœ¨ä½ æ‰¾åˆ°äº†è¿™ä¸ªèƒ½å¤Ÿæ»‹ç”ŸæŠµåˆ¶è¡Œä¸ºçš„åœŸå£¤ï¼ŒH2 çš„é€»è¾‘é“¾æ¡æ›´åŠ å®Œæ•´äº†ã€‚"
        }
    }
];

const game = {
    state: {
        ap: 5,
        chains: { h1: 0, h2: 0, h3: 0 }, // 0-3
        visited: [],
        currentEv: null,
        tutStep: 0
    },

    showScreen: (id) => {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },

    // Theory & Tutorial
    startTheory: () => game.showScreen('screen-theory'),
    
    startTutorial: () => {
        game.state.tutStep = 0;
        game.renderTutorial();
        game.showScreen('screen-tutorial');
    },

    renderTutorial: () => {
        if(game.state.tutStep >= tutorialData.length) {
            // ç®€æŠ¥è¿‡æ¸¡åŠ¨ç”»
            game.showModal("è®­ç»ƒå®Œæˆ", "ä½ å·²æŒæ¡è¯æ®å¼ºåº¦çš„æ ¸å¿ƒæ¦‚å¿µã€‚æ­£åœ¨è½½å…¥Så¸‚æ¡ˆä»¶æ¡£æ¡ˆ...", () => {
                game.startMainGame();
            });
            return;
        }
        const t = tutorialData[game.state.tutStep];
        const html = `
            <div class="evidence-card">${t.text}</div>
            <p style="color: var(--text-muted);">${t.question}</p>
            <div class="options-grid">
                <div class="option-btn" onclick="game.checkTutorial('straw')"><strong>1. é£ä¸­ä¹‹çƒ›</strong></div>
                <div class="option-btn" onclick="game.checkTutorial('hoop')"><strong>2. ç¯å½¢æµ‹è¯•</strong></div>
                <div class="option-btn" onclick="game.checkTutorial('smoking')"><strong>3. å¸çƒŸæª</strong></div>
                <div class="option-btn" onclick="game.checkTutorial('doubly')"><strong>4. åŒé‡å†³å®š</strong></div>
            </div>
        `;
        document.getElementById('tutorial-content').innerHTML = html;
    },

    checkTutorial: (ans) => {
        const t = tutorialData[game.state.tutStep];
        if(ans === t.correct) {
            game.showModal("åˆ¤æ–­æ­£ç¡®", t.msg, () => {
                game.state.tutStep++;
                game.renderTutorial();
            });
        } else {
            game.showModal("åˆ¤æ–­åå·®", "è¯·é‡æ–°æ€è€ƒè¯¥è¯æ®å¯¹äºå‡è®¾çš„å¿…è¦æ€§å’Œå……åˆ†æ€§ã€‚");
        }
    },

    // Main Game
    startMainGame: () => {
        game.state.ap = 5;
        game.state.chains = { h1: 0, h2: 0, h3: 0 };
        game.renderMap();
        game.updateUI();
        game.showScreen('screen-game');
    },

    renderMap: () => {
        const container = document.getElementById('view-map');
        container.innerHTML = mainLocations.map(loc => `
            <div class="map-node ${game.state.visited.includes(loc.id) ? 'visited' : ''}" onclick="game.visit('${loc.id}')">
                <span class="node-icon">${loc.icon}</span>
                <div class="node-title">${loc.title}</div>
                <span class="node-subtitle">${loc.subtitle}</span>
            </div>
        `).join('');
    },

    visit: (id) => {
        if(game.state.visited.includes(id)) return;
        if(game.state.ap <= 0) { game.showModal("è­¦æŠ¥", "è¡ŒåŠ¨ç‚¹æ•°ä¸è¶³ï¼Œè¯·æäº¤æŠ¥å‘Šã€‚"); return; }

        const loc = mainLocations.find(l => l.id === id);
        game.state.currentEv = loc.evidence;
        game.state.currentEv.locId = id;

        document.getElementById('view-map').style.display = 'none';
        document.getElementById('view-investigation').style.display = 'flex';
        
        document.getElementById('inv-title').innerText = loc.id.toUpperCase();
        document.getElementById('evidence-text').innerText = loc.evidence.text;
        document.getElementById('target-h-name').innerText = loc.evidence.targetHName;
        document.getElementById('target-h-name').style.color = `var(--${loc.evidence.targetHKey}-color)`;
    },

    submitAnalysis: (type) => {
        const ev = game.state.currentEv;
        const isCorrect = (type === ev.type);

        if(isCorrect) {
            // Update Logic: Straw=1, Hoop=2, Smoking=3
            let strength = 0;
            if(type === 'straw') strength = 1;
            if(type === 'hoop') strength = 2;
            if(type === 'smoking') strength = 3;

            const currentStrength = game.state.chains[ev.targetHKey];
            if(strength > currentStrength) {
                game.state.chains[ev.targetHKey] = strength;
            }

            game.state.ap--;
            game.state.visited.push(ev.locId);
            game.showModal("åˆ†ææ”¶å½•", ev.msg, () => game.backToMap());
        } else {
            game.state.ap--;
            game.showModal("åˆ†æåå·®", "ä½ çš„åˆ¤æ–­ä¸æ ‡å‡†è¯æ®é€»è¾‘ä¸ç¬¦ã€‚è¯¥è¯æ®å·²ä½œä¸ºæ— æ•ˆæ•°æ®å¤„ç†ã€‚", () => game.backToMap());
        }
    },

    backToMap: () => {
        game.updateUI();
        document.getElementById('view-investigation').style.display = 'none';
        document.getElementById('view-map').style.display = 'grid';
        if(game.state.ap === 0) {
            setTimeout(() => game.showModal("è¡ŒåŠ¨ç»“æŸ", "APç‚¹æ•°è€—å°½ã€‚è¯·ç‚¹å‡»å·¦ä¾§æŒ‰é’®æäº¤æœ€ç»ˆæŠ¥å‘Šã€‚"), 500);
        }
    },

    updateUI: () => {
        // Update Sidebar Viz
        ['h1', 'h2', 'h3'].forEach(key => {
            const val = game.state.chains[key];
            const segs = document.querySelectorAll(`#viz-${key} .chain-segment`);
            const text = document.getElementById(`text-${key}`);
            
            // Clear
            segs.forEach(s => s.className = 'chain-segment');
            
            if(val >= 1) { // Straw
                segs[0].classList.add('active-straw');
                text.innerText = "å¾®å¼±ç›¸å…³ (Straw)";
                text.style.opacity = 0.7;
            }
            if(val >= 2) { // Hoop
                segs[0].classList.add('active-hoop');
                segs[1].classList.add('active-hoop');
                text.innerText = "åŸºç¡€å…·å¤‡ (Hoop)";
                text.style.opacity = 0.9;
            }
            if(val >= 3) { // Smoking
                segs.forEach(s => s.classList.add('active-smoking'));
                text.innerText = "å› æœç¡®è¯ (Confirmed)";
                text.style.opacity = 1;
                text.style.color = "var(--primary)";
            }
        });
        document.getElementById('ap-display').innerText = game.state.ap;
    },

    endGameCheck: () => {
        game.showScreen('screen-end');
        const h2 = game.state.chains.h2;
        const h1 = game.state.chains.h1;
        const h3 = game.state.chains.h3;
        
        let html = "";
        
        // èƒœåˆ©æ¡ä»¶ï¼šH2 æ‰¾åˆ° Smoking Gunï¼Œä¸”æ„è¯†åˆ° H1/H3 åªæœ‰å¼±è¯æ®
        if(h2 >= 3) {
            html = `
                <h3 style="color: var(--primary);">ä»»åŠ¡æˆåŠŸ (MISSION SUCCESS)</h3>
                <p>é€šè¿‡è¯æ®é“¾æ„å»ºï¼Œä½ è¿˜åŸäº†çœŸç›¸ï¼š</p>
                <p>ä½ æ‰¾åˆ°äº†é’ˆå¯¹ <b>H2 å®˜åƒšæŠµåˆ¶</b> çš„<b>å¸çƒŸæª (Smoking Gun)</b> è¯æ®â€”â€”é‚£äº›æ˜ç¡®çš„é˜»æŒ è¡Œä¸ºå’ŒèƒŒåçš„åˆ©ç›ŠåŠ¨æœºã€‚è¿™å½¢æˆäº†ä¸€æ¡å®Œæ•´çš„å› æœé“¾ã€‚</p>
                <p style="color: var(--text-muted);">åŒæ—¶ï¼Œä½ ä¹Ÿæ­£ç¡®åœ°è¯„ä¼°äº† H1 å’Œ H3 çš„è¯æ®å¼ºåº¦â€”â€”å®ƒä»¬ä»…ä»…æ˜¯å¾®å¼±çš„é£ä¸­ä¹‹çƒ›æˆ–åŸºç¡€çš„ç¯å½¢æµ‹è¯•ï¼Œè™½ç„¶éªŒè¯äº†éƒ¨åˆ†äº‹å®ï¼Œä½†ä¸è¶³ä»¥è§£é‡Šæ•´ä¸ªæ¡ˆä»¶ã€‚</p>
                <div style="background: rgba(255,255,255,0.05); padding: 20px; margin-top: 20px; border-left: 2px solid var(--primary);">
                    <b>æ•™æˆè¯„è¯­ï¼š</b><br>
                    "ä¼˜ç§€çš„è°ƒæŸ¥ã€‚ä½ æ²¡æœ‰è¢«'ç³»ç»Ÿæœ‰ç‚¹å¡'æˆ–'å®£ä¼ è´¹æœ‰ç‚¹å°‘'è¿™äº›è¡¨è±¡è¿·æƒ‘ï¼Œè€Œæ˜¯ç›´å‡»äº†æœ€æ ¸å¿ƒçš„æœºåˆ¶â€”â€”åˆ©ç›Šé©±åŠ¨çš„åˆ¶åº¦æ€§æŠµåˆ¶ã€‚"
                </div>
            `;
        } else {
            html = `
                <h3 style="color: #e57373;">ä»»åŠ¡å¤±è´¥ (MISSION INCOMPLETE)</h3>
                <p>ä½ çš„è°ƒæŸ¥æœªèƒ½é”å®šæ ¸å¿ƒçœŸå‡¶ã€‚</p>
                <p>ç›®å‰çš„è¯æ®é“¾ä¸­ï¼Œ<b>H2 å®˜åƒšæŠµåˆ¶</b> è¿™ä¸€å…³é”®å‡è®¾ç¼ºä¹å†³å®šæ€§çš„<b>å¸çƒŸæª</b>è¯æ®ã€‚ä½ å¯èƒ½è¢« H1 æˆ– H3 çš„è¾¹ç¼˜è¯æ®åˆ†æ•£äº†æ³¨æ„åŠ›ï¼Œæˆ–è€…é”™è¿‡äº†å…³é”®çš„æš—è®¿ã€‚</p>
                <p>è¯·è®°ä½ï¼šåœ¨æ”¿ç­–ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬è¦å¯»æ‰¾çš„ä¸ä»…ä»…æ˜¯â€œç›¸å…³æ€§â€ï¼Œè€Œæ˜¯å¼ºæœ‰åŠ›çš„â€œå› æœæœºåˆ¶â€ã€‚</p>
            `;
        }
        document.getElementById('end-content').innerHTML = html;
    },

    // Utility
    showModal: (title, text, callback) => {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerHTML = text;
        const modal = document.getElementById('modal');
        modal.style.display = 'flex';
        
        const btn = modal.querySelector('button');
        btn.onclick = () => {
            modal.style.display = 'none';
            if(callback) callback();
        };
    }
};
</script>
</body>
</html>